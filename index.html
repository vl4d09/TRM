<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Demo - NFT Debug</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        
        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .debug-panel div {
            margin: 3px 0;
        }
        
        .status-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            display: flex;
            gap: 15px;
        }
        
        .marker-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .marker-status .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }
        
        .marker-status.unlocked .dot {
            background: #4CAF50;
        }
        
        .marker-status.active .dot {
            background: #2196F3;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        
        .message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            display: none;
        }
        
        .message.show {
            display: block;
            animation: fadeOut 3s forwards;
        }
        
        .message.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        @keyframes fadeOut {
            0%, 70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div class="debug-panel" id="debug">
        <div><strong>üîç Debug Console</strong></div>
        <div>Camera: <span id="camera-status">‚è≥ Loading...</span></div>
        <div>AR.js: <span id="arjs-status">‚è≥ Loading...</span></div>
        <div>NFT Loading: <span id="nft-status">‚è≥ Waiting...</span></div>
        <div>---</div>
        <div>M1: <span id="m1-status">-</span></div>
        <div>M2: <span id="m2-status">-</span></div>
        <div>M3: <span id="m3-status">-</span></div>
        <div>---</div>
        <div id="logs" style="font-size: 10px; color: #aaa;"></div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="marker-status unlocked" id="status1">
            <span class="dot"></span>
            <span>Marker 1</span>
        </div>
        <div class="marker-status unlocked" id="status2">
            <span class="dot"></span>
            <span>Marker 2</span>
        </div>
        <div class="marker-status unlocked" id="status3">
            <span class="dot"></span>
            <span>Marker 3</span>
        </div>
    </div>
    
    <!-- Message popup -->
    <div class="message" id="message"></div>

    <!-- AR Scene -->
    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; alpha: true;"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: true; trackingMethod: best; detectionMode: mono_and_matrix;">

        <a-assets>
            <a-asset-item id="model1" src="./models/model1.glb"></a-asset-item>
        </a-assets>

        <!-- Lighting -->
        <a-entity light="type: ambient; intensity: 1.0;"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="-1 2 1"></a-entity>

        <!-- NFT Marker 1 - Testing with simple geometry first -->
        <a-nft 
            id="nft1" 
            type="nft" 
            url="./marker1" 
            smooth="true" 
            smoothCount="10" 
            smoothTolerance=".01" 
            smoothThreshold="5">
            
            <!-- Simple red box for testing -->
            <a-box 
                id="test-box"
                position="0 100 0" 
                width="100" 
                height="100" 
                depth="100" 
                color="#FF0000"
                material="opacity: 0.8; transparent: true"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 5000">
            </a-box>
            
            <!-- Text for debugging -->
            <a-text 
                value="NFT 1 WORKS!" 
                position="0 200 0" 
                align="center" 
                color="#00FF00"
                scale="50 50 50">
            </a-text>
        </a-nft>

        <!-- NFT Marker 2 - Disabled for now -->
        <!-- <a-nft id="nft2" type="nft" url="./marker2">
            <a-box position="0 100 0" width="100" height="100" depth="100" color="#00FF00"></a-box>
        </a-nft> -->

        <!-- NFT Marker 3 - Disabled for now -->
        <!-- <a-nft id="nft3" type="nft" url="./marker3">
            <a-box position="0 100 0" width="100" height="100" depth="100" color="#0000FF"></a-box>
        </a-nft> -->

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Get elements
        const cameraStatus = document.getElementById('camera-status');
        const arjsStatus = document.getElementById('arjs-status');
        const nftStatus = document.getElementById('nft-status');
        const m1Status = document.getElementById('m1-status');
        const logs = document.getElementById('logs');
        const messageEl = document.getElementById('message');
        const status1 = document.getElementById('status1');
        
        const nft1 = document.getElementById('nft1');
        const scene = document.querySelector('a-scene');

        // Log function
        function addLog(msg) {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${msg}`;
            console.log(logLine);
            logs.innerHTML = logLine + '<br>' + logs.innerHTML;
            if (logs.children.length > 10) {
                logs.lastChild.remove();
            }
        }

        function showMessage(text, isError = false) {
            messageEl.textContent = text;
            messageEl.className = 'message show' + (isError ? ' error' : '');
            addLog(text);
        }

        // Scene events
        scene.addEventListener('loaded', () => {
            arjsStatus.textContent = '‚úÖ Ready';
            arjsStatus.style.color = '#4CAF50';
            addLog('Scene loaded');
        });

        scene.addEventListener('renderstart', () => {
            cameraStatus.textContent = '‚úÖ Active';
            cameraStatus.style.color = '#4CAF50';
            addLog('Camera started');
        });

        // NFT loading events
        window.addEventListener('arjs-nft-loaded', (e) => {
            nftStatus.textContent = '‚úÖ Loaded';
            nftStatus.style.color = '#4CAF50';
            addLog('NFT loaded: ' + JSON.stringify(e.detail));
            showMessage('‚úÖ NFT markers loaded successfully!');
        });

        // Check if NFT files exist
        async function checkNFTFiles() {
            const files = ['marker1.fset', 'marker1.fset3', 'marker1.iset'];
            for (const file of files) {
                try {
                    const response = await fetch(`./${file}`);
                    if (response.ok) {
                        addLog(`‚úÖ Found: ${file}`);
                    } else {
                        addLog(`‚ùå Missing: ${file}`);
                        nftStatus.textContent = '‚ùå Missing files';
                        nftStatus.style.color = '#f44336';
                    }
                } catch (e) {
                    addLog(`‚ùå Error loading ${file}: ${e.message}`);
                }
            }
        }

        // Marker 1 events
        if (nft1) {
            nft1.addEventListener('markerFound', () => {
                addLog('üéØ MARKER 1 FOUND!!!');
                m1Status.textContent = '‚úÖ FOUND';
                m1Status.style.color = '#4CAF50';
                status1.classList.add('active');
                showMessage('üéØ Marker 1 detected!');
            });
            
            nft1.addEventListener('markerLost', () => {
                addLog('‚ùå Marker 1 lost');
                m1Status.textContent = '‚ö†Ô∏è Lost';
                m1Status.style.color = '#ff9800';
                status1.classList.remove('active');
            });
        } else {
            addLog('‚ùå NFT1 element not found!');
        }

        // Camera permissions
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        })
        .then(() => {
            addLog('‚úÖ Camera permission granted');
        })
        .catch((err) => {
            addLog('‚ùå Camera error: ' + err.message);
            cameraStatus.textContent = '‚ùå DENIED';
            cameraStatus.style.color = '#f44336';
            showMessage('‚ùå Camera access required!', true);
        });

        // Check NFT files on load
        setTimeout(checkNFTFiles, 1000);

        addLog('üöÄ Script loaded');
        console.log('AR.js version:', AFRAME.components.arjs);
    </script>
</body>
</html>